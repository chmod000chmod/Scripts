import java.text.SimpleDateFormat

def date = new Date().format("yyyyMMddHHmm")
def datetostring = date.toString()

pipeline {
  options {
    disableConcurrentBuilds()
    timestamps ()
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30'))
    timeout(time: 45, unit: 'MINUTES')
  }

  agent {
    label "iit-jenkins-slave"
  }

  environment {
    google_application_credentials = credentials('unity-it-btn-prd-creds')
  }

  stages {
    stage('creation stage') {
      steps('test instance creation') {
        script {
          vmList()
          if (machineListed=='deepfreezebaseimage') {
            deleteVM()
          }
            createVM()
            sleep 400
            password()
            input('is this instance valid?')
            snapshot()
            deleteVM() 
        }
      }
    }
  }
}

def deleteVM(){
  sh ("gcloud auth activate-service-account --key-file ${google_application_credentials} && gcloud compute instances delete deepfreezebaseimage --project=unity-it-btn-prd  --zone=europe-west1-b --quiet")
  echo "test instance deleted"
}

def createVM(){
  sh ("gcloud auth activate-service-account --key-file ${google_application_credentials} && gcloud compute instances create deepfreezebaseimage --project=unity-it-btn-prd --zone=europe-west1-b --machine-type=e2-medium --network-interface=network-tier=PREMIUM,subnet=windows-df --metadata=windows-startup-script-url=gs://unitydeepfreezebtn/dfsoftware.ps1 --maintenance-policy=MIGRATE --service-account=293612857084-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append --create-disk=auto-delete=yes,boot=yes,device-name=deepfreezebaseimage,image=projects/windows-cloud/global/images/windows-server-2019-dc-v20211012,mode=rw,size=50,type=projects/unity-it-btn-prd/zones/europe-west1-b/diskTypes/pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any")
  echo "test instance created"
}

def password(){
  sh ("gcloud auth activate-service-account --key-file ${google_application_credentials} && gcloud compute reset-windows-password deepfreezebaseimage --project=unity-it-btn-prd --zone=europe-west1-b --quiet")
  echo "password generated"
}

def snapshot(){
  sh ("gcloud auth activate-service-account --key-file ${google_application_credentials} && gcloud compute disks snapshot deepfreezebaseimage --project=unity-it-btn-prd  --zone=europe-west1-b --snapshot-names=deepfreezebaseimage")
  echo "snapshot created"
}

def vmList(){
      machineListed = sh (
      script: """gcloud auth activate-service-account --key-file ${google_application_credentials} && gcloud compute instances list --project=unity-it-btn-prd --format="table[no-heading](name)" --filter="name=('deepfreezebaseimage')" """,
      returnStdout: true
    ).trim()
}
